import snowflake.connector

from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import serialization

from smart_open import open




print("opening key...")
    
with open('C:\\Users\\Mind-Graph\\OneDrive - Mindgraph Solutions Sdn Bhd\\Desktop\\Globe\\cpp_connector\\cpp_sfprod_rsa_key.p8', "rb") as key:

    p_key= serialization.load_pem_private_key(
    key.read(),
    password='cCpPr0Dp@ss$F'.encode(),
    backend=default_backend()
)


pkb = p_key.private_bytes(
    encoding=serialization.Encoding.DER,
    format=serialization.PrivateFormat.PKCS8,
    encryption_algorithm=serialization.NoEncryption())

    
print("connecting to Snowflake:")
ctx = snowflake.connector.connect(
    user='SF_DB_PRD_ALL_CPP',
    account='pe68509.ap-southeast-1.privatelink',
    private_key=pkb,
    warehouse='PRJ_VWH_UUP_CPP',
    database='PRD_DB_UUP',
    schema='UUP_EXT',
    role='SA_FR_SF_DB_PRD_ALL_CPP'
)

cs = ctx.cursor()

try:
    q = """ select profile_date ,listagg(distinct payment_category_code, '_') as payment_category_code ,listagg(distinct customer_facing_unit_type_code, '_') as customer_facing_unit_type_code ,listagg(distinct brand_sub_type_code, '_') as brand_sub_type_code ,listagg(distinct subscriber_status_code, '_') as subscriber_status_code ,listagg(distinct product_type_description, '_') as product_type_description ,listagg(distinct brand_type_code, '_') as brand_type_code ,listagg(distinct international_traveller_indicator, '_') as international_traveller_indicator ,listagg(distinct gcash_user_indicator, '_') as gcash_user_indicator ,listagg(distinct arpu_category_code, '_') as arpu_category_code ,listagg(distinct last_promo_reg_name, '_') as last_promo_reg_name ,concat(min(reload_average_txn_interval_rolling_90_days), '-', max(reload_average_txn_interval_rolling_90_days)) as reload_average_txn_interval_rolling_90_days ,listagg(distinct primary_resource_type_key, '_') as primary_resource_type_key ,concat(min(reload_daily_average_rolling_90days_amount), '-', max(reload_daily_average_rolling_90days_amount)) as reload_daily_average_rolling_90days_amount ,concat(min(total_amount), '-', max(total_amount)) as total_amount ,concat(min(total_due_amount), '-', max(total_due_amount)) as total_due_amount ,listagg(distinct billing_offer_desc, '_') as billing_offer_desc ,concat(min(msf), '-', max(msf)) as msf ,concat(min(spending_limit_amount), '-', max(spending_limit_amount)) as spending_limit_amount ,concat(min(postpaid_churn_propensity_score), '-', max(postpaid_churn_propensity_score)) as postpaid_churn_propensity_score ,concat(min(postpaid_churn_propensity_decile), '-', max(postpaid_churn_propensity_decile)) as postpaid_churn_propensity_decile ,listagg(distinct sim_lte_capable_indicator, '_') as sim_lte_capable_indicator ,listagg(distinct contract_type_code, '_') as contract_type_code ,concat(min(account_credit_limit), '-', max(account_credit_limit)) as account_credit_limit ,concat(min(customer_credit_limit), '-', max(customer_credit_limit)) as customer_credit_limit ,concat(min(mrf), '-', max(mrf)) as mrf ,listagg(distinct handset_lte_capable_indicator, '_') as handset_lte_capable_indicator ,listagg(distinct gender_type_description, '_') as gender_type_description ,concat(min(gross_monthly_income_amount), '-', max(gross_monthly_income_amount)) as gross_monthly_income_amount ,listagg(distinct customer_facing_unit_type_description, '_') as customer_facing_unit_type_description ,listagg(distinct customer_facing_unit_sub_type_description, '_') as customer_facing_unit_sub_type_description ,listagg(distinct customer_facing_unit_sub_type_code, '_') as customer_facing_unit_sub_type_code ,concat(min(reload_daily_total_rolling_30days_amount), '-', max(reload_daily_total_rolling_30days_amount)) as reload_daily_total_rolling_30days_amount ,listagg(distinct billing_delivery_mode_code, '_') as billing_delivery_mode_code ,concat(min(reload_mode_tu_tra_rolling_90_days_amount), '-', max(reload_mode_tu_tra_rolling_90_days_amount)) as reload_mode_tu_tra_rolling_90_days_amount ,concat(min(reload_monthly_average_rolling_90days_amount), '-', max(reload_monthly_average_rolling_90days_amount)) as reload_monthly_average_rolling_90days_amount ,listagg(distinct home_barangay_name, '_') as home_barangay_name ,listagg(distinct home_city_name, '_') as home_city_name ,listagg(distinct home_province_name, '_') as home_province_name ,listagg(distinct home_region_name, '_') as home_region_name ,listagg(distinct work_barangay_name, '_') as work_barangay_name ,listagg(distinct work_city_name, '_') as work_city_name ,listagg(distinct work_province_name, '_') as work_province_name ,listagg(distinct work_region_name, '_') as work_region_name ,concat(min(tenure_count), '-', max(tenure_count)) as tenure_count ,listagg(distinct owns_credit_card_indicator, '_') as owns_credit_card_indicator ,listagg(distinct owns_car_indicator, '_') as owns_car_indicator ,listagg(distinct affluence, '_') as affluence ,listagg(distinct lifestage, '_') as lifestage ,listagg(distinct mds_journey, '_') as mds_journey ,listagg(distinct income_segment_code, '_') as income_segment_code ,listagg(distinct active_subscriber_indicator, '_') as active_subscriber_indicator ,concat(min(usage_average_data_quantity_rolling_90days_mb), '-', max(usage_average_data_quantity_rolling_90days_mb)) as usage_average_data_quantity_rolling_90days_mb ,listagg(distinct handset_os_name, '_') as handset_os_name ,listagg(distinct handset_manufacturer_name, '_') as handset_manufacturer_name ,listagg(distinct owns_house_indicator, '_') as owns_house_indicator ,concat(min(usage_data_rolling_30_days_quantity), '-', max(usage_data_rolling_30_days_quantity)) as usage_data_rolling_30_days_quantity ,concat(min(credit_loan_limit_amount), '-', max(credit_loan_limit_amount)) as credit_loan_limit_amount ,concat(min(credit_loan_score), '-', max(credit_loan_score)) as credit_loan_score ,listagg(distinct credit_loan_tag, '_') as credit_loan_tag ,concat(min(reload_average_amount_past_120days), '-', max(reload_average_amount_past_120days)) as reload_average_amount_past_120days ,concat(min(reload_date_count_past_120days), '-', max(reload_date_count_past_120days)) as reload_date_count_past_120days ,concat(min(reload_amount_latest_past_90days), '-', max(reload_amount_latest_past_90days)) as reload_amount_latest_past_90days ,concat(min(reload_transaction_count_past_120days), '-', max(reload_transaction_count_past_120days)) as reload_transaction_count_past_120days ,concat(min(usage_data_rolling_90_days_mb), '-', max(usage_data_rolling_90_days_mb)) as usage_data_rolling_90_days_mb ,concat(min(usage_sum_outbound_inter_voice_30days_mins), '-', max(usage_sum_outbound_inter_voice_30days_mins)) as usage_sum_outbound_inter_voice_30days_mins ,concat(min(availment_amount_past_30days), '-', max(availment_amount_past_30days)) as availment_amount_past_30days ,concat(min(availment_count_past_30days), '-', max(availment_count_past_30days)) as availment_count_past_30days ,concat(min(active_days_past_30days), '-', max(active_days_past_30days)) as active_days_past_30days ,concat(min(active_days_past_120days), '-', max(active_days_past_120days)) as active_days_past_120days ,concat(min(usage_data_mb_rolling_120days_quantity), '-', max(usage_data_mb_rolling_120days_quantity)) as usage_data_mb_rolling_120days_quantity ,concat(min(usage_data_count_past_120days), '-', max(usage_data_count_past_120days)) as usage_data_count_past_120days ,concat(min(usage_total_amount_past_30days), '-', max(usage_total_amount_past_30days)) as usage_total_amount_past_30days ,listagg(distinct network_monthly_top_1_voice_location_region, '_') as network_monthly_top_1_voice_location_region ,listagg(distinct network_monthly_top_1_voice_location_province, '_') as network_monthly_top_1_voice_location_province ,listagg(distinct network_monthly_top_1_voice_location_town, '_') as network_monthly_top_1_voice_location_town ,listagg(distinct network_monthly_top_1_voice_location_barangay, '_') as network_monthly_top_1_voice_location_barangay ,listagg(distinct network_monthly_top_1_sms_location_region, '_') as network_monthly_top_1_sms_location_region ,listagg(distinct network_monthly_top_1_sms_location_province, '_') as network_monthly_top_1_sms_location_province ,listagg(distinct network_monthly_top_1_sms_location_town, '_') as network_monthly_top_1_sms_location_town ,listagg(distinct network_monthly_top_1_sms_location_barangay, '_') as network_monthly_top_1_sms_location_barangay ,listagg(distinct network_monthly_top_1_data_location_region, '_') as network_monthly_top_1_data_location_region ,listagg(distinct network_monthly_top_1_data_location_province, '_') as network_monthly_top_1_data_location_province ,listagg(distinct network_monthly_top_1_data_location_town, '_') as network_monthly_top_1_data_location_town ,listagg(distinct network_monthly_top_1_data_location_barangay, '_') as network_monthly_top_1_data_location_barangay ,listagg(distinct online_gamer_indicator, '_') as online_gamer_indicator ,listagg(distinct online_gamer_bucket, '_') as online_gamer_bucket ,listagg(distinct kpop_fan_indicator, '_') as kpop_fan_indicator ,listagg(distinct kpop_fan_bucket, '_') as kpop_fan_bucket ,listagg(distinct music_streamer_indicator, '_') as music_streamer_indicator ,listagg(distinct music_streamer_bucket, '_') as music_streamer_bucket ,listagg(distinct beauty_skin_care_fan_indicator, '_') as beauty_skin_care_fan_indicator ,listagg(distinct beauty_skin_care_fan_bucket, '_') as beauty_skin_care_fan_bucket ,listagg(distinct video_streamer_indicator, '_') as video_streamer_indicator ,listagg(distinct video_streamer_bucket, '_') as video_streamer_bucket ,listagg(distinct online_shopper_indicator, '_') as online_shopper_indicator ,listagg(distinct online_shopper_bucket, '_') as online_shopper_bucket ,listagg(distinct sale_shopper_indicator, '_') as sale_shopper_indicator ,listagg(distinct sale_shopper_bucket, '_') as sale_shopper_bucket ,listagg(distinct travel_enthusiast_indicator, '_') as travel_enthusiast_indicator ,listagg(distinct travel_enthusiast_bucket, '_') as travel_enthusiast_bucket ,listagg(distinct health_buff_indicator, '_') as health_buff_indicator ,listagg(distinct health_buff_bucket, '_') as health_buff_bucket ,listagg(distinct ott_user_indicator, '_') as ott_user_indicator ,listagg(distinct ott_user_bucket, '_') as ott_user_bucket ,listagg(distinct social_media_maverick_indicator, '_') as social_media_maverick_indicator ,listagg(distinct social_media_maverick_bucket, '_') as social_media_maverick_bucket ,listagg(distinct mobile_wallet_user_indicator, '_') as mobile_wallet_user_indicator ,listagg(distinct mobile_wallet_user_bucket, '_') as mobile_wallet_user_bucket ,listagg(distinct road_warrior_indicator, '_') as road_warrior_indicator ,listagg(distinct road_warrior_bucket, '_') as road_warrior_bucket ,listagg(distinct telemedicine_indicator, '_') as telemedicine_indicator ,listagg(distinct telemedicine_bucket, '_') as telemedicine_bucket ,listagg(distinct online_learner_indicator, '_') as online_learner_indicator ,listagg(distinct online_learner_bucket, '_') as online_learner_bucket ,listagg(distinct online_reader_indicator, '_') as online_reader_indicator ,listagg(distinct online_reader_bucket, '_') as online_reader_bucket ,listagg(distinct tnvs_user_indicator, '_') as tnvs_user_indicator ,listagg(distinct tnvs_user_bucket, '_') as tnvs_user_bucket ,listagg(distinct digital_creative_indicator, '_') as digital_creative_indicator ,listagg(distinct digital_creative_bucket, '_') as digital_creative_bucket ,listagg(distinct online_banker_indicator, '_') as online_banker_indicator ,listagg(distinct online_banker_bucket, '_') as online_banker_bucket ,listagg(distinct loyalty_card_owner_indicator, '_') as loyalty_card_owner_indicator ,listagg(distinct loyalty_card_owner_bucket, '_') as loyalty_card_owner_bucket ,listagg(distinct kid_friendly_app_user_indicator, '_') as kid_friendly_app_user_indicator ,listagg(distinct kid_friendly_app_user_bucket, '_') as kid_friendly_app_user_bucket ,concat(min(usage_monthly_total_sms_sent), '-', max(usage_monthly_total_sms_sent)) as usage_monthly_total_sms_sent ,concat(min(usage_monthly_total_outgoing_call_minutes), '-', max(usage_monthly_total_outgoing_call_minutes)) as usage_monthly_total_outgoing_call_minutes ,concat(min(usage_monthly_total_kb_data_used), '-', max(usage_monthly_total_kb_data_used)) as usage_monthly_total_kb_data_used ,listagg(distinct foodie_online_delivery_indicator, '_') as foodie_online_delivery_indicator ,listagg(distinct foodie_online_delivery_bucket, '_') as foodie_online_delivery_bucket ,listagg(distinct restaurant_finder_indicator, '_') as restaurant_finder_indicator ,listagg(distinct restaurant_finder_bucket, '_') as restaurant_finder_bucket ,listagg(distinct historically_purchased_phone_indicator, '_') as historically_purchased_phone_indicator ,listagg(distinct reload_gcash_channel_indicator, '_') as reload_gcash_channel_indicator ,listagg(distinct availment_mode_promo_90days, '_') as availment_mode_promo_90days ,concat(min(arpu_value), '-', max(arpu_value)) as arpu_value ,concat(min(postpaid_arpu_30days), '-', max(postpaid_arpu_30days)) as postpaid_arpu_30days ,concat(min(postpaid_arpu_60days), '-', max(postpaid_arpu_60days)) as postpaid_arpu_60days ,concat(min(reload_ave_transaction_count_30days), '-', max(reload_ave_transaction_count_30days)) as reload_ave_transaction_count_30days ,concat(min(reload_ave_transaction_count_60days), '-', max(reload_ave_transaction_count_60days)) as reload_ave_transaction_count_60days ,concat(min(reload_ave_transaction_count_90days), '-', max(reload_ave_transaction_count_90days)) as reload_ave_transaction_count_90days ,concat(min(derived_age_number), '-', max(derived_age_number)) as derived_age_number ,listagg(distinct age_bracket_name, '_') as age_bracket_name ,concat(min(usage_data_ppu_amount_past_30days), '-', max(usage_data_ppu_amount_past_30days)) as usage_data_ppu_amount_past_30days ,concat(min(usage_sms_ppu_amount_past_30days), '-', max(usage_sms_ppu_amount_past_30days)) as usage_sms_ppu_amount_past_30days ,concat(min(usage_voice_ppu_amount_past_30days), '-', max(usage_voice_ppu_amount_past_30days)) as usage_voice_ppu_amount_past_30days ,concat(min(reload_transaction_count_past_30days), '-', max(reload_transaction_count_past_30days)) as reload_transaction_count_past_30days ,concat(min(reload_transaction_count_past_90days), '-', max(reload_transaction_count_past_90days)) as reload_transaction_count_past_90days ,concat(min(postpaid_arpu_90days), '-', max(postpaid_arpu_90days)) as postpaid_arpu_90days ,listagg(distinct handset_type_name, '_') as handset_type_name ,concat(min(reload_amount_latest_past_60days), '-', max(reload_amount_latest_past_60days)) as reload_amount_latest_past_60days ,concat(min(reload_days_from_last_txn), '-', max(reload_days_from_last_txn)) as reload_days_from_last_txn ,listagg(distinct reload_top_channel_30days, '_') as reload_top_channel_30days ,listagg(distinct reload_top_channel_60days, '_') as reload_top_channel_60days ,listagg(distinct reload_top_channel_90days, '_') as reload_top_channel_90days ,listagg(distinct reload_latest_channel_90days, '_') as reload_latest_channel_90days ,listagg(distinct postpaid_contract_status_type, '_') as postpaid_contract_status_type ,concat(min(prepaid_spending_arpu_30days), '-', max(prepaid_spending_arpu_30days)) as prepaid_spending_arpu_30days ,concat(min(prepaid_spending_arpu_60days), '-', max(prepaid_spending_arpu_60days)) as prepaid_spending_arpu_60days ,concat(min(prepaid_spending_arpu_90days), '-', max(prepaid_spending_arpu_90days)) as prepaid_spending_arpu_90days ,listagg(distinct contract_type_description, '_') as contract_type_description ,listagg(distinct multisim_tag, '_') as multisim_tag ,concat(min(availment_amount_past_90days), '-', max(availment_amount_past_90days)) as availment_amount_past_90days ,concat(min(reload_amount_total_past_90days), '-', max(reload_amount_total_past_90days)) as reload_amount_total_past_90days ,concat(min(previous_msf), '-', max(previous_msf)) as previous_msf ,listagg(distinct bb_technology_value, '_') as bb_technology_value ,listagg(distinct bb_previous_technology_value, '_') as bb_previous_technology_value ,concat(min(contract_period_value), '-', max(contract_period_value)) as contract_period_value ,concat(min(previous_contract_period_value), '-', max(previous_contract_period_value)) as previous_contract_period_value ,concat(min(bb_installation_sequence_number), '-', max(bb_installation_sequence_number)) as bb_installation_sequence_number ,listagg(distinct fashionista_indicator, '_') as fashionista_indicator ,listagg(distinct fashionista_bucket, '_') as fashionista_bucket ,listagg(distinct iot_user_indicator, '_') as iot_user_indicator ,listagg(distinct iot_user_bucket, '_') as iot_user_bucket ,listagg(distinct gcash_user_consented_indicator, '_') as gcash_user_consented_indicator ,concat(min(bb_port_number_value), '-', max(bb_port_number_value)) as bb_port_number_value ,concat(min(usage_sms_ppu_amount_past_90days), '-', max(usage_sms_ppu_amount_past_90days)) as usage_sms_ppu_amount_past_90days ,concat(min(usage_voice_ppu_amount_past_90days), '-', max(usage_voice_ppu_amount_past_90days)) as usage_voice_ppu_amount_past_90days ,listagg(distinct logistics_delivery_app_indicator, '_') as logistics_delivery_app_indicator ,listagg(distinct logistics_delivery_app_bucket, '_') as logistics_delivery_app_bucket ,listagg(distinct bb_plan_migration_type_value, '_') as bb_plan_migration_type_value ,concat(min(lifetime_tenure_count), '-', max(lifetime_tenure_count)) as lifetime_tenure_count ,listagg(distinct platinum_subscriber_indicator, '_') as platinum_subscriber_indicator ,listagg(distinct bb_data_cap_value, '_') as bb_data_cap_value ,listagg(distinct bb_installation_province_name, '_') as bb_installation_province_name ,listagg(distinct bb_data_cap_freq_refresh_value, '_') as bb_data_cap_freq_refresh_value ,listagg(distinct bb_plan_type_value, '_') as bb_plan_type_value ,listagg(distinct spending_segment, '_') as spending_segment ,listagg(distinct spending_by_brand_bucket, '_') as spending_by_brand_bucket ,listagg(distinct spending_overall_bucket, '_') as spending_overall_bucket ,listagg(distinct usage_top_loc_timeblock1_past_30days, '_') as usage_top_loc_timeblock1_past_30days ,listagg(distinct usage_top_loc_timeblock2_past_30days, '_') as usage_top_loc_timeblock2_past_30days ,listagg(distinct usage_top_loc_timeblock3_past_30days, '_') as usage_top_loc_timeblock3_past_30days ,listagg(distinct usage_top_loc_timeblock4_past_30days, '_') as usage_top_loc_timeblock4_past_30days ,listagg(distinct usage_top_loc_timeblock5_past_30days, '_') as usage_top_loc_timeblock5_past_30days ,listagg(distinct usage_top_loc_timeblock6_past_30days, '_') as usage_top_loc_timeblock6_past_30days ,concat(min(usage_data_instagram_mb_past_30days), '-', max(usage_data_instagram_mb_past_30days)) as usage_data_instagram_mb_past_30days ,concat(min(usage_data_tiktok_mb_past_30days), '-', max(usage_data_tiktok_mb_past_30days)) as usage_data_tiktok_mb_past_30days ,concat(min(globe_website_visit_count_rolling_30days), '-', max(globe_website_visit_count_rolling_30days)) as globe_website_visit_count_rolling_30days ,concat(min(globe_website_visit_average_count_rolling_90days), '-', max(globe_website_visit_average_count_rolling_90days)) as globe_website_visit_average_count_rolling_90days ,concat(min(reload_prepaid_arpu_30days), '-', max(reload_prepaid_arpu_30days)) as reload_prepaid_arpu_30days ,concat(min(reload_prepaid_arpu_60days), '-', max(reload_prepaid_arpu_60days)) as reload_prepaid_arpu_60days ,concat(min(usage_data_consumable_mb_past_90days), '-', max(usage_data_consumable_mb_past_90days)) as usage_data_consumable_mb_past_90days ,listagg(distinct assigned_handset_manufacturer_name, '_') as assigned_handset_manufacturer_name ,listagg(distinct payment_channel_mode_90days, '_') as payment_channel_mode_90days ,concat(min(usage_data_mb_past_60days), '-', max(usage_data_mb_past_60days)) as usage_data_mb_past_60days ,concat(min(usage_data_mb_past_30days), '-', max(usage_data_mb_past_30days)) as usage_data_mb_past_30days ,concat(min(inactive_avg_consec_days_last_90days), '-', max(inactive_avg_consec_days_last_90days)) as inactive_avg_consec_days_last_90days ,listagg(distinct postpaid_current_gah_user_indicator, '_') as postpaid_current_gah_user_indicator ,concat(min(inactive_max_consec_days_past_90days), '-', max(inactive_max_consec_days_past_90days)) as inactive_max_consec_days_past_90days ,concat(min(inactive_min_consec_days_past_90days), '-', max(inactive_min_consec_days_past_90days)) as inactive_min_consec_days_past_90days ,concat(min(usage_data_active_days_past_30days), '-', max(usage_data_active_days_past_30days)) as usage_data_active_days_past_30days ,concat(min(usage_data_active_days_past_90days), '-', max(usage_data_active_days_past_90days)) as usage_data_active_days_past_90days ,concat(min(billing_cycle_code), '-', max(billing_cycle_code)) as billing_cycle_code ,listagg(distinct days_past_due_bucket, '_') as days_past_due_bucket ,listagg(distinct online_shopper_top_apps, '_') as online_shopper_top_apps ,listagg(distinct online_gamer_top_apps, '_') as online_gamer_top_apps ,listagg(distinct video_streamer_top_apps, '_') as video_streamer_top_apps ,listagg(distinct music_streamer_top_apps, '_') as music_streamer_top_apps ,listagg(distinct online_banker_mode, '_') as online_banker_mode ,listagg(distinct mobile_wallet_user_mode, '_') as mobile_wallet_user_mode ,listagg(distinct credit_card_user_mode, '_') as credit_card_user_mode ,listagg(distinct foodie_online_delivery_top_apps, '_') as foodie_online_delivery_top_apps ,listagg(distinct restaurant_finder_top_apps, '_') as restaurant_finder_top_apps ,listagg(distinct social_media_maverick_top_apps, '_') as social_media_maverick_top_apps ,listagg(distinct telemedicine_top_apps, '_') as telemedicine_top_apps ,listagg(distinct health_buff_top_apps, '_') as health_buff_top_apps ,listagg(distinct online_reader_top_apps, '_') as online_reader_top_apps ,listagg(distinct ott_user_top_apps, '_') as ott_user_top_apps ,listagg(distinct loyalty_card_owner_mode, '_') as loyalty_card_owner_mode ,listagg(distinct aspiring_chef_top_apps, '_') as aspiring_chef_top_apps ,listagg(distinct online_learner_top_apps, '_') as online_learner_top_apps ,listagg(distinct digital_creative_top_apps, '_') as digital_creative_top_apps ,listagg(distinct productivity_tools_user_top_apps, '_') as productivity_tools_user_top_apps ,concat(min(usage_voice_inter_consumable_mins_90days), '-', max(usage_voice_inter_consumable_mins_90days)) as usage_voice_inter_consumable_mins_90days ,concat(min(usage_voice_intra_consumable_mins_90days), '-', max(usage_voice_intra_consumable_mins_90days)) as usage_voice_intra_consumable_mins_90days ,listagg(distinct mdm_type_code, '_') as mdm_type_code ,listagg(distinct mds_journey2, '_') as mds_journey2 ,concat(min(usage_data_ppu_past_amount_90days), '-', max(usage_data_ppu_past_amount_90days)) as usage_data_ppu_past_amount_90days ,concat(min(remaining_contract_period_months), '-', max(remaining_contract_period_months)) as remaining_contract_period_months ,listagg(distinct beauty_skin_care_fan_top_apps, '_') as beauty_skin_care_fan_top_apps ,listagg(distinct bpo_worker_top_apps, '_') as bpo_worker_top_apps ,listagg(distinct fashionista_top_apps, '_') as fashionista_top_apps ,listagg(distinct iot_user_top_apps, '_') as iot_user_top_apps ,listagg(distinct kid_friendly_top_apps, '_') as kid_friendly_top_apps ,listagg(distinct logistics_delivery_top_apps, '_') as logistics_delivery_top_apps ,listagg(distinct productivity_tools_user_indicator, '_') as productivity_tools_user_indicator ,listagg(distinct productivity_tools_user_bucket, '_') as productivity_tools_user_bucket ,listagg(distinct kpop_fan_top_apps, '_') as kpop_fan_top_apps ,listagg(distinct road_warrior_top_apps, '_') as road_warrior_top_apps ,listagg(distinct tnvs_user_top_apps, '_') as tnvs_user_top_apps ,listagg(distinct coffee_lover_indicator, '_') as coffee_lover_indicator ,listagg(distinct coffee_lover_bucket, '_') as coffee_lover_bucket ,listagg(distinct coffee_lover_top_apps, '_') as coffee_lover_top_apps ,listagg(distinct chi_indicator, '_') as chi_indicator ,listagg(distinct nps_detractor_indicator, '_') as nps_detractor_indicator ,listagg(distinct bank_caller_indicator, '_') as bank_caller_indicator ,listagg(distinct bank_caller_mode, '_') as bank_caller_mode ,listagg(distinct bank_caller_bucket, '_') as bank_caller_bucket ,listagg(distinct sim_tag, '_') as sim_tag ,listagg(distinct fraud_indicator, '_') as fraud_indicator ,concat(min(chi_happiness_score), '-', max(chi_happiness_score)) as chi_happiness_score ,concat(min(chi_quality_score), '-', max(chi_quality_score)) as chi_quality_score ,listagg(distinct chi_segment, '_') as chi_segment ,concat(min(chi_expectation_score), '-', max(chi_expectation_score)) as chi_expectation_score ,concat(min(chi_value_score), '-', max(chi_value_score)) as chi_value_score ,listagg(distinct address_province_name, '_') as address_province_name ,listagg(distinct address_region_name, '_') as address_region_name ,listagg(distinct address_zip_code, '_') as address_zip_code ,listagg(distinct content_creator_indicator, '_') as content_creator_indicator ,listagg(distinct content_creator_bucket, '_') as content_creator_bucket ,listagg(distinct content_creator_top_apps, '_') as content_creator_top_apps ,listagg(distinct stock_trader_indicator, '_') as stock_trader_indicator ,listagg(distinct stock_trader_bucket, '_') as stock_trader_bucket ,listagg(distinct stock_trader_top_apps, '_') as stock_trader_top_apps ,listagg(distinct martial_arts_fan_indicator, '_') as martial_arts_fan_indicator ,listagg(distinct martial_arts_fan_bucket, '_') as martial_arts_fan_bucket ,listagg(distinct martial_arts_fan_top_apps, '_') as martial_arts_fan_top_apps ,listagg(distinct comics_reader_indicator, '_') as comics_reader_indicator ,listagg(distinct comics_reader_bucket, '_') as comics_reader_bucket ,listagg(distinct comics_reader_top_apps, '_') as comics_reader_top_apps ,listagg(distinct grab_driver_indicator, '_') as grab_driver_indicator ,listagg(distinct grab_driver_bucket, '_') as grab_driver_bucket ,listagg(distinct bpo_worker_indicator, '_') as bpo_worker_indicator ,listagg(distinct bpo_worker_bucket, '_') as bpo_worker_bucket ,listagg(distinct aspiring_chef_indicator, '_') as aspiring_chef_indicator ,listagg(distinct aspiring_chef_bucket, '_') as aspiring_chef_bucket ,concat(min(interaction_count_30days), '-', max(interaction_count_30days)) as interaction_count_30days ,listagg(distinct interaction_top_channel_30days, '_') as interaction_top_channel_30days ,concat(min(interaction_top_channel_count_30days), '-', max(interaction_top_channel_count_30days)) as interaction_top_channel_count_30days ,listagg(distinct credit_card_user_indicator, '_') as credit_card_user_indicator ,listagg(distinct credit_card_user_bucket, '_') as credit_card_user_bucket ,listagg(distinct parent_indicator, '_') as parent_indicator ,listagg(distinct sale_shopper_top_apps, '_') as sale_shopper_top_apps ,listagg(distinct basketball_fan_bucket, '_') as basketball_fan_bucket ,listagg(distinct basketball_fan_indicator, '_') as basketball_fan_indicator ,listagg(distinct basketball_fan_top_apps, '_') as basketball_fan_top_apps ,listagg(distinct car_dealer_caller_bucket, '_') as car_dealer_caller_bucket ,listagg(distinct car_dealer_caller_indicator, '_') as car_dealer_caller_indicator ,listagg(distinct car_enthusiast_bucket, '_') as car_enthusiast_bucket ,listagg(distinct car_enthusiast_indicator, '_') as car_enthusiast_indicator ,listagg(distinct car_enthusiast_top_apps, '_') as car_enthusiast_top_apps ,listagg(distinct dating_around_bucket, '_') as dating_around_bucket ,listagg(distinct dating_around_indicator, '_') as dating_around_indicator ,listagg(distinct dating_around_top_apps, '_') as dating_around_top_apps ,listagg(distinct insurance_caller_bucket, '_') as insurance_caller_bucket ,listagg(distinct insurance_caller_indicator, '_') as insurance_caller_indicator ,listagg(distinct insurance_caller_mode, '_') as insurance_caller_mode ,listagg(distinct liquor_lover_bucket, '_') as liquor_lover_bucket ,listagg(distinct liquor_lover_indicator, '_') as liquor_lover_indicator ,listagg(distinct liquor_lover_top_apps, '_') as liquor_lover_top_apps ,listagg(distinct online_freelancer_bucket, '_') as online_freelancer_bucket ,listagg(distinct online_freelancer_indicator, '_') as online_freelancer_indicator ,listagg(distinct online_freelancer_top_apps, '_') as online_freelancer_top_apps ,listagg(distinct thrifty_nanay_bucket, '_') as thrifty_nanay_bucket ,listagg(distinct thrifty_nanay_indicator, '_') as thrifty_nanay_indicator ,listagg(distinct thrifty_nanay_mode, '_') as thrifty_nanay_mode ,listagg(distinct health_conscious_indicator, '_') as health_conscious_indicator ,listagg(distinct health_conscious_bucket, '_') as health_conscious_bucket ,listagg(distinct health_conscious_top_apps, '_') as health_conscious_top_apps ,listagg(distinct book_worm_indicator, '_') as book_worm_indicator ,listagg(distinct book_worm_bucket, '_') as book_worm_bucket ,listagg(distinct book_worm_top_apps, '_') as book_worm_top_apps ,listagg(distinct network_monthly_top_1_data_location_region_code, '_') as network_monthly_top_1_data_location_region_code ,listagg(distinct network_monthly_top_1_data_location_province_code, '_') as network_monthly_top_1_data_location_province_code ,listagg(distinct network_monthly_top_1_data_location_town_code, '_') as network_monthly_top_1_data_location_town_code ,listagg(distinct network_monthly_top_1_data_location_barangay_code, '_') as network_monthly_top_1_data_location_barangay_code ,listagg(distinct network_monthly_top_1_location_region, '_') as network_monthly_top_1_location_region ,listagg(distinct network_monthly_top_1_location_region_code, '_') as network_monthly_top_1_location_region_code ,listagg(distinct network_monthly_top_1_location_province, '_') as network_monthly_top_1_location_province ,listagg(distinct network_monthly_top_1_location_province_code, '_') as network_monthly_top_1_location_province_code ,listagg(distinct network_monthly_top_1_location_town, '_') as network_monthly_top_1_location_town ,listagg(distinct network_monthly_top_1_location_town_code, '_') as network_monthly_top_1_location_town_code ,listagg(distinct network_monthly_top_1_location_barangay, '_') as network_monthly_top_1_location_barangay ,listagg(distinct network_monthly_top_1_location_barangay_code, '_') as network_monthly_top_1_location_barangay_code ,listagg(distinct network_element_name, '_') as network_element_name ,listagg(distinct "4g_upgrade_indicator", '_') as "4g_upgrade_indicator" ,listagg(distinct job_hunter_indicator, '_') as job_hunter_indicator ,listagg(distinct job_hunter_bucket, '_') as job_hunter_bucket ,listagg(distinct job_hunter_top_apps, '_') as job_hunter_top_apps ,concat(min(avg_daily_dl_speed_lte_90days), '-', max(avg_daily_dl_speed_lte_90days)) as avg_daily_dl_speed_lte_90days ,concat(min(avg_daily_latency_speed_lte_90days), '-', max(avg_daily_latency_speed_lte_90days)) as avg_daily_latency_speed_lte_90days ,concat(min(availment_mode_promo_amount_90days), '-', max(availment_mode_promo_amount_90days)) as availment_mode_promo_amount_90days ,concat(min(prepaid_spending_past_30days), '-', max(prepaid_spending_past_30days)) as prepaid_spending_past_30days ,concat(min(prepaid_spending_arpu_past_90days), '-', max(prepaid_spending_arpu_past_90days)) as prepaid_spending_arpu_past_90days ,listagg(distinct viber_user_indicator, '_') as viber_user_indicator ,listagg(distinct tech_savvy_indicator, '_') as tech_savvy_indicator ,listagg(distinct tech_savvy_bucket, '_') as tech_savvy_bucket ,listagg(distinct tech_savvy_top_apps, '_') as tech_savvy_top_apps ,listagg(distinct gambler_indicator, '_') as gambler_indicator ,listagg(distinct gambler_bucket, '_') as gambler_bucket ,listagg(distinct gambler_top_apps, '_') as gambler_top_apps ,listagg(distinct womens_health_app_indicator, '_') as womens_health_app_indicator ,listagg(distinct womens_health_app_bucket, '_') as womens_health_app_bucket ,listagg(distinct womens_health_top_apps, '_') as womens_health_top_apps ,listagg(distinct handset_brand_name_categorized, '_') as handset_brand_name_categorized ,listagg(distinct handset_os_name_categorized, '_') as handset_os_name_categorized ,concat(min(prepaid_spending_decline_month_on_month), '-', max(prepaid_spending_decline_month_on_month)) as prepaid_spending_decline_month_on_month ,concat(min(prepaid_spending_decline_past_90days), '-', max(prepaid_spending_decline_past_90days)) as prepaid_spending_decline_past_90days ,listagg(distinct sports_buddy_indicator, '_') as sports_buddy_indicator ,listagg(distinct sports_buddy_bucket, '_') as sports_buddy_bucket ,listagg(distinct sports_buddy_top_apps, '_') as sports_buddy_top_apps ,listagg(distinct crypto_wallet_user_indicator, '_') as crypto_wallet_user_indicator ,listagg(distinct crypto_wallet_user_bucket, '_') as crypto_wallet_user_bucket ,listagg(distinct crypto_wallet_user_top_apps, '_') as crypto_wallet_user_top_apps ,listagg(distinct plant_parent_indicator, '_') as plant_parent_indicator ,listagg(distinct plant_parent_bucket, '_') as plant_parent_bucket ,listagg(distinct plant_parent_top_apps, '_') as plant_parent_top_apps ,listagg(distinct news_pub_follower_top_apps, '_') as news_pub_follower_top_apps ,listagg(distinct news_pub_follower_bucket, '_') as news_pub_follower_bucket ,listagg(distinct news_pub_follower_indicator, '_') as news_pub_follower_indicator ,listagg(distinct local_entertainment_top_apps, '_') as local_entertainment_top_apps ,listagg(distinct local_entertainment_app_bucket, '_') as local_entertainment_app_bucket ,listagg(distinct local_entertainment_app_indicator, '_') as local_entertainment_app_indicator ,listagg(distinct international_shopper_top_apps, '_') as international_shopper_top_apps ,listagg(distinct international_shopper_bucket, '_') as international_shopper_bucket ,listagg(distinct international_shopper_indicator, '_') as international_shopper_indicator ,listagg(distinct online_grocery_shopper_top_apps, '_') as online_grocery_shopper_top_apps ,listagg(distinct online_grocery_shopper_bucket, '_') as online_grocery_shopper_bucket ,listagg(distinct online_grocery_shopper_indicator, '_') as online_grocery_shopper_indicator ,concat(min(availment_promo_decline_month_on_month), '-', max(availment_promo_decline_month_on_month)) as availment_promo_decline_month_on_month ,concat(min(availment_promo_decline_past_90days), '-', max(availment_promo_decline_past_90days)) as availment_promo_decline_past_90days ,concat(min(availment_promo_ave_past_90days), '-', max(availment_promo_ave_past_90days)) as availment_promo_ave_past_90days ,concat(min(availment_ave_days_between_promo_90days), '-', max(availment_ave_days_between_promo_90days)) as availment_ave_days_between_promo_90days ,concat(min(availment_ave_days_between_promo_120days), '-', max(availment_ave_days_between_promo_120days)) as availment_ave_days_between_promo_120days ,listagg(distinct occupation_text_categorized, '_') as occupation_text_categorized ,listagg(distinct musician_indicator, '_') as musician_indicator ,listagg(distinct musician_bucket, '_') as musician_bucket ,listagg(distinct musician_top_apps, '_') as musician_top_apps ,listagg(distinct reload_activity_decline_indicator, '_') as reload_activity_decline_indicator ,listagg(distinct gender_type_description_user, '_') as gender_type_description_user ,listagg(distinct civil_status, '_') as civil_status ,listagg(distinct civil_status_user, '_') as civil_status_user ,listagg(distinct online_seller_indicator, '_') as online_seller_indicator ,listagg(distinct online_seller_bucket, '_') as online_seller_bucket ,listagg(distinct online_seller_top1_app, '_') as online_seller_top1_app ,listagg(distinct hmo_member_indicator, '_') as hmo_member_indicator ,listagg(distinct hmo_member_bucket, '_') as hmo_member_bucket ,listagg(distinct hmo_member_top1_app, '_') as hmo_member_top1_app ,concat(min(reload_total_topup_amount_past_7days), '-', max(reload_total_topup_amount_past_7days)) as reload_total_topup_amount_past_7days ,listagg(distinct insurance_app_indicator, '_') as insurance_app_indicator ,listagg(distinct insurance_app_bucket, '_') as insurance_app_bucket ,listagg(distinct insurance_top_apps, '_') as insurance_top_apps ,listagg(distinct age_bracket_name_user, '_') as age_bracket_name_user ,concat(min(derived_age_number_user), '-', max(derived_age_number_user)) as derived_age_number_user ,concat(min(prepaid_topup_segment), '-', max(prepaid_topup_segment)) as prepaid_topup_segment ,listagg(distinct lifestyle_app_indicator, '_') as lifestyle_app_indicator ,listagg(distinct lifestyle_app_bucket, '_') as lifestyle_app_bucket ,listagg(distinct lifestyle_top_apps, '_') as lifestyle_top_apps ,listagg(distinct superapp_user_indicator, '_') as superapp_user_indicator ,concat(min(prepaid_migration_propensity_decile), '-', max(prepaid_migration_propensity_decile)) as prepaid_migration_propensity_decile ,concat(min(reload_amount_mtd), '-', max(reload_amount_mtd)) as reload_amount_mtd ,listagg(distinct usage_data_shift_indicator, '_') as usage_data_shift_indicator ,listagg(distinct usage_sms_shift_indicator, '_') as usage_sms_shift_indicator ,listagg(distinct usage_voice_shift_indicator, '_') as usage_voice_shift_indicator ,concat(min(reload_amount_past_mo1), '-', max(reload_amount_past_mo1)) as reload_amount_past_mo1 ,concat(min(reload_amount_past_mo2), '-', max(reload_amount_past_mo2)) as reload_amount_past_mo2 ,concat(min(reload_amount_past_mo3), '-', max(reload_amount_past_mo3)) as reload_amount_past_mo3 ,concat(min(reload_amount_past_mo4), '-', max(reload_amount_past_mo4)) as reload_amount_past_mo4 ,concat(min(reload_amount_past_mo5), '-', max(reload_amount_past_mo5)) as reload_amount_past_mo5 ,concat(min(reload_amount_past_mo6), '-', max(reload_amount_past_mo6)) as reload_amount_past_mo6 ,concat(min(reload_amount_past_mo7), '-', max(reload_amount_past_mo7)) as reload_amount_past_mo7 ,concat(min(reload_amount_past_mo8), '-', max(reload_amount_past_mo8)) as reload_amount_past_mo8 ,concat(min(reload_amount_past_mo9), '-', max(reload_amount_past_mo9)) as reload_amount_past_mo9 ,concat(min(reload_amount_past_mo10), '-', max(reload_amount_past_mo10)) as reload_amount_past_mo10 ,concat(min(reload_amount_past_mo11), '-', max(reload_amount_past_mo11)) as reload_amount_past_mo11 ,concat(min(reload_amount_past_mo12), '-', max(reload_amount_past_mo12)) as reload_amount_past_mo12 ,listagg(distinct top_data_cell_site_capability, '_') as top_data_cell_site_capability ,listagg(distinct latest_handset_capability, '_') as latest_handset_capability ,listagg(distinct predicted_arpu_change, '_') as predicted_arpu_change ,listagg(distinct prepaid_topup_cohort, '_') as prepaid_topup_cohort ,listagg(distinct hpw_prepaid_topup_segment, '_') as hpw_prepaid_topup_segment ,concat(min(broadcast_exclude_indicator), '-', max(broadcast_exclude_indicator)) as broadcast_exclude_indicator ,concat(min(survival_regression_score_6mos), '-', max(survival_regression_score_6mos)) as survival_regression_score_6mos ,listagg(distinct household_segment, '_') as household_segment ,listagg(distinct household_decision_tag, '_') as household_decision_tag ,listagg(distinct mobile_bridging_segment, '_') as mobile_bridging_segment ,concat(min(gross_service_revenue_indicative_amount_past_1mo), '-', max(gross_service_revenue_indicative_amount_past_1mo)) as gross_service_revenue_indicative_amount_past_1mo ,concat(min(gross_service_revenue_indicative_amount_average_past_2mos), '-', max(gross_service_revenue_indicative_amount_average_past_2mos)) as gross_service_revenue_indicative_amount_average_past_2mos ,concat(min(gross_service_revenue_indicative_amount_average_past_3mos), '-', max(gross_service_revenue_indicative_amount_average_past_3mos)) as gross_service_revenue_indicative_amount_average_past_3mos ,concat(min(tenure_count_mos), '-', max(tenure_count_mos)) as tenure_count_mos ,listagg(distinct ofw_relative_indicator, '_') as ofw_relative_indicator ,concat(min(rewards_point_balance), '-', max(rewards_point_balance)) as rewards_point_balance ,concat(min(mobility_radius_of_gyration_weekly), '-', max(mobility_radius_of_gyration_weekly)) as mobility_radius_of_gyration_weekly ,concat(min(mobility_radius_of_gyration_monthly), '-', max(mobility_radius_of_gyration_monthly)) as mobility_radius_of_gyration_monthly ,concat(min(mobility_total_traveled_distance_weekly), '-', max(mobility_total_traveled_distance_weekly)) as mobility_total_traveled_distance_weekly ,concat(min(mobility_total_traveled_distance_monthly), '-', max(mobility_total_traveled_distance_monthly)) as mobility_total_traveled_distance_monthly ,concat(min(mobility_activity_entropy_weekly), '-', max(mobility_activity_entropy_weekly)) as mobility_activity_entropy_weekly ,concat(min(mobility_activity_entropy_monthly), '-', max(mobility_activity_entropy_monthly)) as mobility_activity_entropy_monthly ,listagg(distinct primary_sim_indicator, '_') as primary_sim_indicator ,listagg(distinct multi_line_indicator, '_') as multi_line_indicator ,concat(min(mobility_center_of_mass_latitude_weekly), '-', max(mobility_center_of_mass_latitude_weekly)) as mobility_center_of_mass_latitude_weekly ,concat(min(mobility_center_of_mass_longitude_weekly), '-', max(mobility_center_of_mass_longitude_weekly)) as mobility_center_of_mass_longitude_weekly ,concat(min(mobility_center_of_mass_latitude_monthly), '-', max(mobility_center_of_mass_latitude_monthly)) as mobility_center_of_mass_latitude_monthly ,concat(min(mobility_center_of_mass_longitude_monthly), '-', max(mobility_center_of_mass_longitude_monthly)) as mobility_center_of_mass_longitude_monthly ,concat(min(mobility_index_average_baseline_daily), '-', max(mobility_index_average_baseline_daily)) as mobility_index_average_baseline_daily ,concat(min(mobility_index_average_baseline_weekly), '-', max(mobility_index_average_baseline_weekly)) as mobility_index_average_baseline_weekly ,concat(min(mobility_index_average_baseline_monthly), '-', max(mobility_index_average_baseline_monthly)) as mobility_index_average_baseline_monthly ,concat(min(mobility_index_average_baseline_weekday), '-', max(mobility_index_average_baseline_weekday)) as mobility_index_average_baseline_weekday ,concat(min(mobility_index_average_baseline_weekend), '-', max(mobility_index_average_baseline_weekend)) as mobility_index_average_baseline_weekend ,listagg(distinct caif_by_50pct_active_days_indicator, '_') as caif_by_50pct_active_days_indicator ,listagg(distinct caif_by_25pct_active_days_indicator, '_') as caif_by_25pct_active_days_indicator ,concat(min(billing_offer_speed_mbps), '-', max(billing_offer_speed_mbps)) as billing_offer_speed_mbps from PRD_DB_UUP.UUP_EXT.subscriber_profile_vw group by profile_date order by profile_date desc limit 1  """
    cs.execute(q)
    # cs.execute("select distinct globeone_user_indicator, COUNT(coalesce(globeone_user_indicator, '0')) OVER (PARTITION BY globeone_user_indicator) from PRD_DB_UUP.UUP_EXT.subscriber_profile_vw")
   #"select globeone_user_indicator, count(coalesce(globeone_user_indicator,'0')) from PRD_DB_UUP.UUP_EXT.subscriber_profile_vw group by globeone_user_indicator"
    df = cs.fetch_pandas_all()
    print(df)
    df.to_csv('output_prd.csv')
finally:
    cs.close()
ctx.close()